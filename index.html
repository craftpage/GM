<!DOCTYPE html>
<html>
<head>
    <title>micro:bit Acceleration Graph v11</title>
    <script src="https://unpkg.com/htmx.org@1.8.0/dist/htmx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/noble-device@2.2.4/dist/noble-device.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="connection-status">Connecting...</div>
    <button id="scan">Scan</button>
    <button id="connectButton" disabled>Connect</button>
    <div id="chart-container">
        <canvas id="accelerationChart"></canvas>
    </div>

    <script>
        // サービスとキャラクタリスティックのUUID
        const UUID_ACCELERATION_SERVICE = 'e95d7b77-251d-470a-a062-fa1922dfa9a8';
        const UUID_ACCELERATION_DATA = 'e95dca4b-251d-470a-a062-fa1922dfa9a8';

        // グローバル変数
        let device = null;
        let server = null;
        let accelerationCharacteristic = null;
        let chart = null;
        let isConnected = false;

        // 接続ステータスを更新する関数
        function updateConnectionStatus(status) {
            document.getElementById('connection-status').textContent = status;
        }

        // スキャン
        async function scan() {
            device = await navigator.bluetooth.requestDevice({
            filters: [
            { services: [UUID_ACCELERATION_SERVICE] },
            { namePrefix: "BBC micro:bit" }
            ]
        });
        }

        // 接続
        // micro:bit に接続する関数
        async function connectToMicrobit() {
            try {
                server = await device.gatt.connect();
                updateConnectionStatus('Connected to device.');
                await discoverCharacteristics();
                isConnected = true;
            } catch (error) {
                console.error('Error connecting to device:', error);
                updateConnectionStatus('Error connecting. Please try again.');
            }
        }


        // 加速度計の特性を発見する関数
        async function discoverCharacteristics() {
            try {
                const accelerationService = await server.getPrimaryService(UUID_ACCELERATION_SERVICE);
                accelerationCharacteristic = await accelerationService.getCharacteristic(UUID_ACCELERATION_DATA);
                await accelerationCharacteristic.startNotifications();
                accelerationCharacteristic.addEventListener('characteristicvaluechanged', onAccelerationChanged);
            } catch (error) {
                console.error('Error discovering characteristics:', error);
                updateConnectionStatus('Error discovering characteristics.');
            }
        }

        // 加速度計データを受け取ったときのイベントハンドラー
        function onAccelerationChanged(event) {
            const x = event.target.value.getInt8(0, true);
            const y = event.target.value.getInt8(1, true);
            const z = event.target.value.getInt8(2, true);
            updateChart(x, y, z);
        }

        // Chart.js を初期化する関数
        function createChart() {
            const chartCanvas = document.getElementById('accelerationChart');
            chart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'X',
                            data: [],
                            borderColor: 'red',
                            borderWidth: 1
                        },
                        {
                            label: 'Y',
                            data: [],
                            borderColor: 'green',
                            borderWidth: 1
                        },
                        {
                            label: 'Z',
                            data: [],
                            borderColor: 'blue',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // グラフを更新する関数
        function updateChart(x, y, z) {
            chart.data.labels.push(Date.now());
            chart.data.datasets[0].data.push(x);
            chart.data.datasets[1].data.push(y);
            chart.data.datasets[2].data.push(z);
            chart.update();
        }

        // 接続ボタンがクリックされたときのイベントハンドラー
        document.getElementById('scan').addEventListener('click', () => {
            if (!isConnected) {
                scan();
            } else {
                // 接続済みなら切断処理を追加できます
            }
        });

        document.getElementById('connectButton').addEventListener('click', () => {
            if (!isConnected) {
                connectToMicrobit();
            } else {
                // 接続済みなら切断処理を追加できます
            }
        });

        // ページがロードされたときの初期化
        window.onload = () => {
            createChart();
            updateConnectionStatus('Scanning for micro:bit...');
        };
    </script>
</body>
</html>