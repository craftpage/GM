<!DOCTYPE html>
<html>
<head>
    <title>micro:bit Acceleration Graph</title>
    <script src="https://unpkg.com/htmx.org@1.8.0/dist/htmx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/noble-device@2.2.4/dist/noble-device.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="connection-status">Connecting...</div>
    <button id="connectButton">connect</button>
    <div id="chart-container">
        <canvas id="accelerationChart"></canvas>
    </div>

    <script>
        const UUID_TEMPERATURE_SERVICE = 'e95d6100-251d-470a-a062-fa1922dfa9a8';
        const UUID_ACCELERATION_SERVICE = 'e95d7b77-251d-470a-a062-fa1922dfa9a8';
        const UUID_ILLUMINANCE_SERVICE = 'e95d9715-251d-470a-a062-fa1922dfa9a8';

    // キャラクタリスティック UUID
        const UUID_TEMPERATURE_DATA = 'e95d9250-251d-470a-a062-fa1922dfa9a8';
        const UUID_ACCELERATION_DATA = 'e95dca4b-251d-470a-a062-fa1922dfa9a8';
        const UUID_ILLUMINANCE_DATA = 'e95da21b-251d-470a-a062-fa1922dfa9a8';

        let device = null;


        // BLE スキャンと接続のための変数
        let accelerationCharacteristic = null;
        let connectedDevice = null;
        let chart = null;
        let isConnected = false; // 接続状態を管理するフラグ

        // 接続ステータスを更新する関数
        function updateConnectionStatus(status) {
            document.getElementById('connection-status').textContent = status;
        }

        // micro:bit に接続する関数
        async function connectToMicrobit() {
            device = await navigator.bluetooth.requestDevice({ })
            server = await device.gatt.connect();
        }

        // 加速度計の特性を発見する関数
        async function discoverCharacteristics(device) {
            service_acc = await server.getPrimaryService(UUID_ACCELERATION_SERVICE);
            char_acc = await service_acc.getCharacteristic(UUID_ACCELERATION_DATA);
            await char_acc.startNotifications();
            await char_acc.addEventListener('characteristicvaluechanged', onAccelerationChanged);

            let x = event.target.value.getInt8(0, true);
            let y = event.target.value.getInt8(1, true);
            let z = event.target.value.getInt8(2, true);
                
            updateChart(x, y, z);
        }

        // Chart.js を初期化する関数
        function createChart() {
            const chartCanvas = document.getElementById('accelerationChart');
            chart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'X',
                            data: [],
                            borderColor: 'red',
                            borderWidth: 1
                        },
                        {
                            label: 'Y',
                            data: [],
                            borderColor: 'green',
                            borderWidth: 1
                        },
                        {
                            label: 'Z',
                            data: [],
                            borderColor: 'blue',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // グラフを更新する関数
        function updateChart(x, y, z) {
            chart.data.labels.push(Date.now());
            chart.data.datasets[0].data.push(x);
            chart.data.datasets[1].data.push(y);
            chart.data.datasets[2].data.push(z);
            chart.update();
        }

        // 接続ボタンがクリックされたときのイベントハンドラー
        document.getElementById('connectButton').addEventListener('click', () => {
            if (!isConnected) { // 接続されていない場合のみ接続処理を実行
                connectToMicrobit();
            } else {
                // 接続済みの場合は切断処理を追加できます
                // 例：disconnectFromMicrobit();
            }
        });

        // ページがロードされたときの初期化
        window.onload = () => {
            createChart();
        };
    </script>
</body>
</html> 
</html>